
# OpenAI Responses API 移行計画 再検証レポート (report2.md)

## 1. 総括

コードベース全体の再検証の結果、OpenAI Responses APIへの移行は**技術的に実現可能であり、かつ当初の想定よりも低リスクで実行できる**と結論付けます。

特に重要な発見は以下の2点です。

1.  **リクエスト変換の負担は軽微**: 既存のリクエスト変換ロジック (`src/middlewares/formatRequest.ts`) の大部分は、新しいAPIでも**再利用可能**です。完全な書き換えは不要であり、変更は追加と微調整に留まります。
2.  **ストリーム処理は大幅に簡素化**: Web検索機能は、結果をプレーンテキストとしてストリーミングするため、最も複雑だった`tool_use`ブロックの生成ロジックが不要になります。これにより、`src/utils/stream.ts` の実装は**よりシンプルで保守性の高いものに改善**されます。

ただし、既存の**プラグインシステム (`plugins/*.js`) には互換性がなくなる**という重大な影響があります。この点は明確なリスクとして認識する必要があります。

---

## 2. 技術仕様の再検証

### 2.1. API呼び出し (`openai.responses.create`)

`openai-node` SDKの仕様を再確認したところ、`responses.create` の `input` パラメータは、`chat.completions.create` の `messages` パラメータと互換性のある構造 (`Array<{role: string, content: any}>`) を受け入れます。

この事実は、既存の複雑なメッセージ変換ロジックをほぼそのまま流用できることを意味し、移行コストを大幅に削減します。

### 2.2. ストリーミングイベント (`web_search_preview`)

Web検索を有効にした場合のストリーミングイベントを再度調査した結果、以下の流れであることが確実となりました。

1.  `response.output_text.delta`: 検索クエリの生成、検索実行中のメッセージ、検索結果の要約、引用リンクなど、**全ての情報がテキストの断片として**このイベントで順次送信されます。
2.  `response.tool_call.*`: Web検索ツール利用時、このイベントは**発生しません**。
3.  `response.done`: 全てのテキストが送信された後に、ストリームの終了を通知します。

このシンプルなイベントモデルにより、クライアント（Claude拡張機能）が期待するSSE（Server-Sent Events）への変換が非常に容易になります。

---

## 3. ファイル別・影響分析 (詳細版)

### 3.1. `src/middlewares/formatRequest.ts` (影響: 小)

-   **再評価**: 当初は全面的な書き換えを想定していましたが、**不要**です。既存のロジックはAnthropicの複雑なメッセージ形式をOpenAI互換のシンプルなメッセージ配列に変換するものであり、この処理は新しいAPIでも必須です。
-   **変更計画**:
    1.  既存の変換処理はそのまま維持します。
    2.  変換処理の**最後**に、新しいリクエストボディを構築します。
    3.  `system` プロンプトを `instructions` にマッピングします。
    4.  変換済みの `messages` 配列を `input` にマッピングします。
    5.  `tools: [{ type: "web_search_preview" }]` を固定で追加します。
    6.  `stream: true` を設定します。

### 3.2. `src/utils/stream.ts` (影響: 大・ただし簡素化)

-   **再評価**: このファイルの全面的な書き換えは必要ですが、その内容は**大幅にシンプルに**なります。状態管理（`isToolUse`, `toolUseJson`など）の大部分が不要になります。
-   **変更計画**: `streamOpenAIResponse`関数を、以下のAnthropic SSE仕様に厳密に従う形で再実装します。
    1.  **`message_start`**: ストリーム開始時にまず送信します。
    2.  **`content_block_start`**: 最初の `response.output_text.delta` を受信したタイミングで一度だけ送信します。`content_block` の `type` は `'text'` になります。
    3.  **`content_block_delta`**: `response.output_text.delta` を受信するたびに、その内容を `delta: { type: 'text_delta', text: ... }` として送信します。
    4.  **`content_block_stop`**: `response.done` を受信し、かつテキストブロックが開始されていた場合に送信します。
    5.  **`message_delta`**: `response.done` 受信時に、最終的な `stop_reason` を含めて送信します。
    6.  **`message_stop`**: 全てのイベントの最後に送信し、通信を正常に終了させます。

### 3.3. `src/index.ts` (影響: 極小)

-   **再評価**: 変更はAPI呼び出しの1行のみで、他に影響はありません。
-   **変更計画**: `openai.chat.completions.create` を `openai.responses.create` に変更します。

### 3.4. `plugins/*.js` (影響: 甚大・互換性喪失)

-   **再評価**: `plugins/deepseek.js` は `streamOpenAIResponse` を直接 `require` して利用しています。他のプラグインもミドルウェアとしてリクエスト/レスポンスボディを操作しており、APIの根本的な変更により正常に動作しなくなります。
-   **リスク**: これらのプラグインは**完全に機能しなくなります**。
-   **対策**:
    -   **短期的**: 今回の改修ではプラグインの互換性維持はスコープ外とし、プラグイン機能を一時的に無効化する（`server.ts` で読み込まないなど）。
    -   **長期的**: `responses.create` APIを前提として、プラグインを別途書き直す必要があります。

---

## 4. リスク分析と最終実装計画

### 4.1. リスク

| リスク内容 | 影響度 | 発生確率 | 対策 |
| :--- | :--- | :--- | :--- |
| **プラグインの非互換性** | **高** | **確実** | プラグイン機能を無効化し、改修が必要なことを明確にドキュメント化する。 |
| **カスタムツールの非サポート** | 中 | 確実 | 今回の改修はWeb検索に特化する。将来的にカスタムツールが必要な場合は、`response.tool_call.delta` を処理する追加開発を行う。 |
| **エラー形式の差異** | 低 | 高 | 新しいAPIのエラー形式 (`response.error`) を`stream.ts`で捕捉し、クライアントに適切に通知するロジックを実装する。 |

### 4.2. 最終実装ブループリント

以下の順序で実装を進めることを強く推奨します。

1.  **準備**: `server.ts` を編集し、全てのプラグインを読み込む処理を一時的にコメントアウトします。
2.  **リクエスト変換 (`formatRequest.ts`)**: 既存ロジックの末尾に、`instructions`, `input`, `tools` を設定する処理を追記します。
3.  **API呼び出し (`index.ts`)**: `chat.completions.create` を `responses.create` に変更します。
4.  **ストリーム処理 (`stream.ts`)**: `streamOpenAIResponse` 関数を、上記「3.2.」の仕様に沿って完全に書き換えます。
5.  **テスト**: 実際にWeb検索を含むクエリを送信し、クライアント側でテキストが正常にストリーミングされることを確認します。

## 5. 結論

本再検証により、移行計画の解像度が大幅に向上し、当初の想定よりも安全かつ効率的に実装可能であることが確認できました。特に、最も複雑な部分が簡素化されるという点は大きなメリットです。

プラグインの互換性喪失というトレードオフを許容すれば、この計画は`claude-code-router`に強力なWeb検索機能をもたらす、確実性の高いアップグレードとなります。
